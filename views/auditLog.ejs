<!DOCTYPE html>
<html>
<head>
  <title>System Activity Log – Audit Trail</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <%- include("partials/navbar") %>
  <div class="sidebar-hover-zone"></div>
  <%- include("partials/sidebar") %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>System Activity Log</h1>
  </div>

  <table class="table table-bordered table-striped table-sm align-middle">
    <thead class="table-dark">
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Action</th>
        <th>Entity</th>
        <th>Entity ID</th>
        <th>Source</th>
        <th>Old → New (What changed)</th>
        <th>Remarks</th>
      </tr>
    </thead>
    <tbody>
      <% if (logs && logs.length > 0) { %>
        <% logs.forEach(log => { %>
          <tr>
            <!-- Time -->
            <td>
              <% if (log.timestamp) { %>
                <%= new Date(log.timestamp).toISOString().slice(0,19).replace('T',' ') %>
              <% } else { %>
                -
              <% } %>
            </td>

            <!-- User -->
            <td>
              <strong><%= log.username || log.user_email || 'System' %></strong>
            </td>

            <!-- Action -->
            <td><%= log.action_type || '-' %></td>

            <!-- Entity -->
            <td><%= log.entity_type || '-' %></td>

            <!-- Entity ID -->
            <td><code><%= log.entity_id || '-' %></code></td>

            <!-- Source -->
            <td><%= log.source || 'Web' %></td>

            <!-- Old → New -->
            <td style="max-width: 420px; font-size: 0.85rem;">
              <% if (log.field && (log.old_value || log.new_value)) { %>
                <div>
                  <strong><code><%= log.field %></code>:</strong>
                  <code><%= log.old_value !== undefined && log.old_value !== null ? log.old_value : '-' %></code>
                  &nbsp;&rarr;&nbsp;
                  <code><%= log.new_value !== undefined && log.new_value !== null ? log.new_value : '-' %></code>
                </div>
              <% } else if (log.old_value || log.new_value) { %>
                <div>
                  <strong>Old:</strong>
                  <code><%= log.old_value !== undefined ? log.old_value : '-' %></code>
                </div>
                <div>
                  <strong>New:</strong>
                  <code><%= log.new_value !== undefined ? log.new_value : '-' %></code>
                </div>
              <% } else { %>
                <span class="text-muted">No value change recorded</span>
              <% } %>
            </td>

            <!-- Remarks -->
            <td><%= log.remarks || '' %></td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="8" class="text-center text-muted">
            No audit log entries found.
          </td>
        </tr>
      <% } %>
    </tbody>
  </table>

  <a href="/deliveries" class="btn btn-secondary">Back to Deliveries</a>

  <footer class="bg-dark text-white py-3 mt-4">
    <div class="container text-center">
      <p class="mb-0 text-sm">&copy; Placeholder TXT</p>
    </div>
  </footer>
</body>
</html>
